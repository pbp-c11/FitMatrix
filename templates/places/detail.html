{% extends "base.html" %}
{% load static %}
{% block title %}{{ place.name }} | FitMatrix{% endblock %}

{% block content %}
<article class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-10 pb-24 space-y-16">
  <header class="space-y-6">
    <div class="matrix-detail-gallery">
      <div class="matrix-detail-gallery__hero relative overflow-hidden">
        {% with image=place.hero_image|default:'media/hero-athlete.jpg' %}
          {% if image and '://' in image %}
            <img src="{{ image }}" alt="{{ place.name }}" class="w-full h-full object-cover" />
          {% else %}
            <img src="{% static image %}" alt="{{ place.name }}" class="w-full h-full object-cover" />
          {% endif %}
        {% endwith %}
        <div class="matrix-hero-grid"></div>
        <div class="absolute inset-0 bg-gradient-to-t from-[#031016] via-transparent to-transparent"></div>
        <div class="absolute bottom-6 left-6 matrix-chip">{{ place.facility_type }}</div>
      </div>
      <div class="matrix-detail-gallery__stack grid gap-3">
        {% with gallery=place.gallery_list %}
          {% if gallery %}
            {% for image in gallery|slice:":3" %}
              <img
                src="{% if image and '://' in image %}{{ image }}{% else %}{% static image %}{% endif %}"
                alt="Gallery image {{ forloop.counter }}"
                class="w-full h-40 object-cover rounded-2xl"
              />
            {% endfor %}
          {% else %}
            <img src="{% static 'media/outdoor-matrix.jpg' %}" alt="Outdoor rig" class="w-full h-40 object-cover rounded-2xl" />
            <img src="{% static 'media/aqua-circuit.jpg' %}" alt="Aquatic training" class="w-full h-40 object-cover rounded-2xl" />
            <img src="{% static 'media/studio-flow.jpg' %}" alt="Studio flow" class="w-full h-40 object-cover rounded-2xl" />
          {% endif %}
        {% endwith %}
      </div>
    </div>

    <div class="flex flex-col gap-6 md:flex-row md:items-end md:justify-between">
      <div class="space-y-4 max-w-3xl">
        <p class="matrix-label">{{ place.facility_type }} facility</p>
        <h1 class="text-4xl sm:text-[3rem] font-semibold leading-tight">{{ place.name }}</h1>
        <p class="text-forest-muted text-base sm:text-lg">{{ place.summary|default:place.tagline }}</p>
        <div class="matrix-pill-group">
          <span class="matrix-pill">{{ place.city }}</span>
          <span class="matrix-pill">{{ place.address }}</span>
          <span class="matrix-pill">{{ place.price_display }}</span>
          <span class="matrix-pill">Avg rating {{ place.rating_avg|floatformat:1 }}</span>
        </div>
      </div>

      <div class="space-y-4 matrix-glass matrix-glow px-6 py-5 rounded-3xl min-w-[260px]">
        <div class="flex flex-col gap-2">
          <span class="matrix-meta-label">Price</span>
          <span class="matrix-price-tag text-2xl">{{ place.price_display }}</span>
        </div>
        <div class="flex flex-col gap-2">
          <span class="matrix-meta-label">Likes</span>
          <span class="matrix-meta-value">{{ place.likes }}</span>
        </div>
        <div class="flex flex-col gap-2">
          <span class="matrix-meta-label">Highlight score</span>
          <span class="matrix-meta-value">{{ place.highlight_score }}</span>
        </div>
        {% if request.user.is_authenticated %}
          <button
            type="button"
            class="matrix-btn w-full"
            data-variant="ghost"
            data-wishlist-toggle
            data-url="{% url 'wishlist:toggle' 'place' place.pk %}"
            data-active="{% if is_favorite %}true{% else %}false{% endif %}"
            data-label-active="Saved"
            data-label-inactive="Save to wishlist"
            aria-pressed="{% if is_favorite %}true{% else %}false{% endif %}"
          >
            {% if is_favorite %}Saved{% else %}Save to wishlist{% endif %}
          </button>
        {% else %}
          <a href="{% url 'accounts:login' %}?next={{ request.path }}" class="matrix-btn w-full" data-variant="ghost">Login to save</a>
        {% endif %}
      </div>
    </div>
  </header>

  {# ======================== REVIEWS PANEL ======================== #}
  <section id="reviews-panel" class="space-y-4">
    <h2 class="matrix-section-title">Reviews</h2>

    <div class="matrix-glass matrix-shadow rounded-[26px] border border-transparent p-5">
      {# ---- form tulis review ---- #}
      <div class="mb-5">
        {% if request.user.is_authenticated %}
          <form id="review-form" action="{% url 'places:review_create' place.slug %}" method="post" class="space-y-3">
            {% csrf_token %}
            <div class="flex items-center gap-3">
              <label class="text-sm opacity-70">Rating</label>
              <select name="rating" class="matrix-input !py-2 !px-3">
                <option value="5">5</option>
                <option value="4">4</option>
                <option value="3">3</option>
                <option value="2">2</option>
                <option value="1">1</option>
              </select>
            </div>
            <textarea name="body" rows="3" class="matrix-input w-full" placeholder="Share your experienceâ€¦"></textarea>
            <div id="review-form-errors"></div>
            <button type="submit" class="matrix-btn">Submit review</button>
          </form>
        {% else %}
          <div class="text-sm opacity-70">
            You must <a class="underline" href="{% url 'accounts:login' %}?next={{ request.path }}">login</a> to write a review.
          </div>
        {% endif %}
      </div>

      {# ---- trigger + container list ---- #}
      <button id="see-reviews" class="matrix-btn" data-variant="ghost" aria-expanded="false" data-loaded="false">
        See reviews
      </button>
      <div id="reviews-container" class="mt-4" hidden></div>
    </div>
  </section>
  {# ====================== /REVIEWS PANEL ======================== #}

  <section class="space-y-6">
    <h2 class="matrix-section-title">Amenities matrix</h2>
    <div class="matrix-pill-group">
      {% for amenity in place.amenities_list %}
        <span class="matrix-pill">{{ amenity }}</span>
      {% empty %}
        <span class="matrix-pill">High-spec equipment</span>
        <span class="matrix-pill">Recovery lounge</span>
        <span class="matrix-pill">Locker suite</span>
      {% endfor %}
    </div>
  </section>

  {% if nearby %}
    <section class="space-y-6">
      <h2 class="matrix-section-title">Nearby synergies</h2>
      <div class="matrix-grid">
        {% include "places/_cards.html" with places=nearby %}
      </div>
    </section>
  {% endif %}

  <section class="space-y-8">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-5">
      <h2 class="matrix-section-title">More recommendations</h2>
      <a href="{% url 'search:results' %}" class="matrix-btn" data-variant="ghost">Back to search</a>
    </div>
    <div class="matrix-grid">
      {% include "places/_cards.html" with places=recommended %}
    </div>
  </section>

  {# ==================== SCRIPTS ===================== #}
  <div id="toastContainer" class="fixed bottom-6 right-6 space-y-2 z-50"></div>

  <div
    id="collectionModal"
    class="fixed inset-0 z-50 hidden items-end sm:items-center justify-center bg-black/60 backdrop-blur"
    role="dialog"
    aria-modal="true"
  >
    <div class="w-full sm:w-[480px] bg-white dark:bg-slate-900 rounded-t-3xl sm:rounded-3xl p-6 space-y-4 shadow-2xl">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h3 class="text-xl font-semibold">Save to collection</h3>
          <p class="text-sm text-slate-500 dark:text-white/60">Add {{ place.name }} into an existing collection or create a new one.</p>
        </div>
        <button type="button" id="cancelModal" class="matrix-btn" data-variant="ghost">Close</button>
      </div>
      <form id="collectionForm" class="space-y-4">
        {% csrf_token %}
        <div>
          <label for="collectionSelect" class="matrix-label">Choose collection</label>
          <select id="collectionSelect" class="matrix-input">
            <option value="__new__">+ Create new collection</option>
          </select>
        </div>
        <div id="newFields" class="space-y-3">
          <div>
            <label for="collection_name" class="matrix-label">Collection name</label>
            <input id="collection_name" name="collection_name" type="text" class="matrix-input" placeholder="e.g. Morning rides" />
          </div>
          <div>
            <label for="collection_desc" class="matrix-label">Description <span class="text-xs text-white/40">(optional)</span></label>
            <textarea id="collection_desc" name="collection_desc" rows="2" class="matrix-input" placeholder="Add a short note"></textarea>
          </div>
        </div>
        <div class="flex items-center gap-3 justify-end">
          <button type="button" id="cancelModalSecondary" class="matrix-btn" data-variant="ghost">Cancel</button>
          <button type="submit" class="matrix-btn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
  (function () {
    const openBtn = document.getElementById('openCollectionModal');
    const modal = document.getElementById('collectionModal');
    const cancelBtn = document.getElementById('cancelModal');
    const cancelSecondary = document.getElementById('cancelModalSecondary');
    const form = document.getElementById('collectionForm');
    const selectEl = document.getElementById('collectionSelect');
    const newFields = document.getElementById('newFields');
    const toastContainer = document.getElementById('toastContainer');

    const csrfField = document.querySelector('#collectionForm input[name="csrfmiddlewaretoken"]');
    const CSRF = csrfField ? csrfField.value : '';
    const PLACE_ID = '{{ place.id }}';
    const PLACE_NAME = "{{ place.name|escapejs }}";

    const showToast = (message, tone = 'success') => {
      const toast = document.createElement('div');
      toast.className = `px-4 py-3 rounded-xl shadow-lg text-white ${tone === 'error' ? 'bg-red-500' : 'bg-emerald-500'} animate-[fadeInUp_0.3s_ease-out]`;
      toast.textContent = message;
      toastContainer.appendChild(toast);
      setTimeout(() => {
        toast.classList.add('opacity-0', 'translate-y-2');
        setTimeout(() => toast.remove(), 400);
      }, 2600);
    };

    const toggleModal = (show) => {
      if (!modal) { return; }
      if (show) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      } else {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    };

    const loadCollections = async () => {
      const res = await fetch("{% url 'accounts:get-user-collections' %}");
      if (!res.ok) return;
      const data = await res.json();
      selectEl.innerHTML = '<option value="__new__">+ Create new collection</option>';
      data.collections.forEach((col) => {
        const opt = document.createElement('option');
        opt.value = col.id;
        opt.textContent = col.name;
        selectEl.appendChild(opt);
      });
    };

    openBtn?.addEventListener('click', async () => {
      toggleModal(true);
      await loadCollections();
    });

    const closeModal = () => toggleModal(false);
    cancelBtn?.addEventListener('click', closeModal);
    cancelSecondary?.addEventListener('click', closeModal);
    modal?.addEventListener('click', (event) => {
      if (event.target === modal) closeModal();
    });

    selectEl?.addEventListener('change', () => {
      newFields.style.display = selectEl.value === '__new__' ? 'block' : 'none';
    });

    form?.addEventListener('submit', async (event) => {
      event.preventDefault();
      const isNew = selectEl.value === '__new__';
      const url = isNew ? "{% url 'accounts:create-collection' %}" : "{% url 'accounts:add-to-collection' %}";
      const payload = isNew ? {
        name: document.getElementById('collection_name').value,
        description: document.getElementById('collection_desc').value,
        place_id: PLACE_ID,
      } : {
        collection_id: selectEl.value,
        place_id: PLACE_ID,
      };

      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': CSRF,
          'X-Requested-With': 'XMLHttpRequest',
        },
        body: JSON.stringify(payload),
      });

      const data = await res.json();
      if (!res.ok) {
        showToast(data.error || 'Failed to save collection.', 'error');
        return;
      }

      if (data.status === 'exists') {
        showToast('Already saved in that collection.', 'error');
      } else {
        const collectionName = data.collection?.name || data.collection || payload.name;
        showToast(`${PLACE_NAME} saved to "${collectionName}".`);
        closeModal();
      }
    });
  })();

  (function () {
    const btn = document.getElementById('see-reviews');
    const container = document.getElementById('reviews-container');
    const form = document.getElementById('review-form');
    const baseUrl = "{% url 'places:reviews_partial' place.slug %}";
    const createUrl = "{% url 'places:review_create' place.slug %}";
    let currentParams = new URLSearchParams({sort: 'created_at', dir: 'desc'});

    function showSkeleton(n=3){
      container.innerHTML = '';
      for(let i=0;i<n;i++){
        const d=document.createElement('div');
        d.className="w-full h-16 rounded-2xl bg-black/5 dark:bg-white/10 animate-pulse my-2";
        container.appendChild(d);
      }
    }

    async function loadReviews(params){
      showSkeleton();
      const res = await fetch(`${baseUrl}?${params.toString()}`, {
        headers:{'X-Requested-With':'XMLHttpRequest'}
      });
      const text = await res.text();
      container.innerHTML = text;
      if (res.ok) wireFilterButtons();
    }

    function wireFilterButtons(){
      // kecilkan tombol filter + samakan gaya dengan "See reviews"
      container.querySelectorAll('[data-filter]').forEach(el=>{
        el.classList.add('matrix-btn','text-sm');
        el.setAttribute('data-variant','ghost');
        el.classList.add('!py-1','!px-2');

        el.addEventListener('click', (e)=>{
          const sort = e.currentTarget.getAttribute('data-filter');
          const dir = e.currentTarget.getAttribute('data-dir') || 'desc';
          currentParams.set('sort', sort);
          currentParams.set('dir', dir);
          container.querySelectorAll('[data-filter]').forEach(b=>{
            const s=b.getAttribute('data-filter'); const d=b.getAttribute('data-dir')||'desc';
            b.setAttribute('aria-pressed', (s===sort && d===dir) ? 'true':'false');
          });
          loadReviews(currentParams);
        });
      });
    }

    btn.addEventListener('click', async ()=>{
      const expanded = btn.getAttribute('aria-expanded') === 'true';
      if (!expanded) {
        container.hidden = false;
        btn.setAttribute('aria-expanded','true');
        if (btn.getAttribute('data-loaded') === 'false') {
          btn.setAttribute('data-loaded','true');
          await loadReviews(currentParams);
        }
      } else {
        container.hidden = true;
        btn.setAttribute('aria-expanded','false');
      }
    });

    // AJAX submit review (login required)
    if (form) {
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const errorsBox = document.getElementById('review-form-errors');
        errorsBox.innerHTML = '';
        const formData = new FormData(form);
        const res = await fetch(createUrl, {
          method: 'POST',
          headers: {'X-Requested-With':'XMLHttpRequest', 'X-CSRFToken': getCookie('csrftoken')},
          body: formData
        });
        const data = await res.json();
        if (data.ok) {
          container.innerHTML = data.html;   // refresh list
          wireFilterButtons();
          form.reset();
          // kalau list belum dibuka, buka
          btn.setAttribute('aria-expanded','true');
          container.hidden = false;
        } else {
          errorsBox.innerHTML = data.errors_html || '<p class="text-red-600 text-sm">Failed to submit.</p>';
        }
      });
    }

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
    }
  })();
  </script>
</article>
{% endblock %}
