{% extends "base.html" %}
{% load static %}
{% block title %}{{ place.name }} | FitMatrix{% endblock %}

{% block content %}
<article class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-10 pb-24 space-y-16">

  <!-- HERO & GALLERY -->
  <section class="grid md:grid-cols-4 gap-4 mt-6">
    <div class="md:col-span-3 relative rounded-3xl overflow-hidden shadow-md">
      {% with image=place.hero_image|default:'media/hero-athlete.jpg' %}
        {% if image and '://' in image %}
          <img src="{{ image }}" alt="{{ place.name }}" class="w-full h-[320px] object-cover" />
        {% else %}
          <img src="{% static image %}" alt="{{ place.name }}" class="w-full h-[320px] object-cover" />
        {% endif %}
      {% endwith %}
      <span class="absolute top-3 left-3 bg-[#C9FFD4] text-[#083D2F] text-xs font-semibold px-3 py-1 rounded-full shadow-sm">
        {{ place.facility_type|default:"GYM" }}
      </span>
    </div>

    <div class="flex flex-col gap-3">
      {% with gallery=place.gallery_list %}
        {% if gallery %}
          {% for image in gallery|slice:":3" %}
            <img src="{% if image and '://' in image %}{{ image }}{% else %}{% static image %}{% endif %}"
                 alt="Gallery image {{ forloop.counter }}"
                 class="w-full h-[100px] object-cover rounded-2xl" />
          {% endfor %}
        {% else %}
          <img src="{% static 'media/outdoor-matrix.jpg' %}" class="w-full h-[100px] object-cover rounded-2xl" />
          <img src="{% static 'media/aqua-circuit.jpg' %}" class="w-full h-[100px] object-cover rounded-2xl" />
          <img src="{% static 'media/studio-flow.jpg' %}" class="w-full h-[100px] object-cover rounded-2xl" />
        {% endif %}
      {% endwith %}
    </div>
  </section>

  <!-- MAIN INFO + ADD TO COLLECTION -->
  <section class="grid md:grid-cols-3 gap-10 mt-4">
    <!-- LEFT -->
    <div class="md:col-span-2 space-y-6">
      <p class="bg-[#E8FFE8] text-[#0E3A22] text-xs font-semibold px-4 py-1 rounded-full inline-block">
        {{ place.facility_type }}
      </p>
      <h1 class="text-3xl sm:text-[2.2rem] font-semibold text-[#12391E]">{{ place.name }}</h1>
      <p class="text-[#3E6147] text-sm sm:text-base leading-relaxed">{{ place.summary|default:place.tagline }}</p>

      <div class="flex flex-wrap gap-2 mt-2">
        {% for amenity in place.amenities_list|slice:":6" %}
          <span class="inline-flex items-center gap-1 rounded-full border border-[#8EEA6E] bg-[#8EEA6E]/30 text-[#0B2A12] px-3 py-1 text-xs font-semibold shadow-sm">{{ amenity }}</span>
        {% empty %}
          <span class="inline-flex items-center gap-1 rounded-full border border-emerald-400/60 bg-white text-emerald-900 px-3 py-1 text-xs font-semibold shadow-sm">Shower Room</span>
          <span class="inline-flex items-center gap-1 rounded-full border border-emerald-400/60 bg-white text-emerald-900 px-3 py-1 text-xs font-semibold shadow-sm">Jacuzzi</span>
          <span class="inline-flex items-center gap-1 rounded-full border border-emerald-400/60 bg-white text-emerald-900 px-3 py-1 text-xs font-semibold shadow-sm">Good Facilities</span>
        {% endfor %}
      </div>

      <!-- LOCATION -->
      <div class="mt-4 grid gap-4 sm:grid-cols-5">
        <div class="sm:col-span-3 rounded-2xl border border-[#8EEA6E]/70 bg-white p-5 shadow-sm">
          <div class="flex items-start justify-between gap-3">
            <h3 class="text-[#0E3A22] font-semibold">Location</h3>
            <div class="flex items-center gap-2">
              <a href="https://www.google.com/maps/search/?api=1&query={{ place.name|urlencode }}%20{{ place.address|urlencode }}%20{{ place.city|urlencode }}"
                 target="_blank" class="matrix-btn !text-xs !px-3 !py-1" data-variant="ghost">Open in Maps</a>
              <button type="button" id="copyAddressBtn"
                      data-addr="{{ place.address }}{% if place.city %}, {{ place.city }}{% endif %}"
                      class="matrix-btn !text-xs !px-3 !py-1" data-variant="ghost">Copy</button>
            </div>
          </div>
          <div class="mt-2 space-y-0.5">
            <p class="text-sm text-[#315739]">{{ place.address|default:"Jl. Example No. 12, Jakarta" }}</p>
            <p class="text-sm text-[#315739]/80">{{ place.city }}</p>
          </div>
        </div>

        <div class="sm:col-span-2 rounded-2xl border border-[#8EEA6E]/70 bg-white p-3 shadow-sm">
          <div class="h-36 rounded-xl ring-1 ring-emerald-300/50 bg-white/70 grid place-items-center">
            <div class="text-center">
              <div class="text-emerald-900 text-sm font-semibold">Map preview</div>
              <div class="text-emerald-900/70 text-xs">Will show live map once coordinates are added</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: ADD TO COLLECTION -->
    <div class="bg-white/60 backdrop-blur-md border border-white/40 shadow-md rounded-3xl p-6 space-y-5">
      <h3 class="text-lg font-semibold text-[#0E3A22]">Add to Collection</h3>
      {% if request.user.is_authenticated %}
        <form id="collectionForm"
              data-add-url="{% url 'accounts:add-to-collection' %}"
              data-create-url="{% url 'accounts:create-collection' %}"
              class="space-y-4">
          {% csrf_token %}
          <div>
            <label class="text-xs font-semibold text-[#356B3A] mb-1 block">Save To</label>
            <select id="collectionSelect" name="collection_id"
                    class="matrix-input w-full rounded-full border border-[#A5E1A2] text-sm px-3 py-2 bg-white/80 hover:bg-white transition">
              <option value="">+ Create New Collection</option>
            </select>
          </div>

          <div id="newCollectionFields" class="space-y-4">
            <div>
              <label class="text-xs font-semibold text-[#356B3A] mb-1 block">Collection Name</label>
              <input type="text" id="collectionName" name="name"
                    class="matrix-input w-full rounded-xl border border-[#A5E1A2] text-sm px-3 py-2"
                    placeholder="Name your collection">
            </div>
            <div>
              <label class="text-xs font-semibold text-[#356B3A] mb-1 block">Description</label>
              <textarea id="collectionDesc" name="description"
                        class="matrix-input w-full rounded-xl border border-[#A5E1A2] text-sm px-3 py-2"
                        rows="2" placeholder="Add a short description"></textarea>
            </div>
          </div>

          <button type="submit"
                  class="w-full flex items-center justify-center gap-2 px-4 py-2 rounded-full bg-gradient-to-r from-[#8EEA6E] to-[#5DD65B] text-[#0B2A12] font-semibold text-sm hover:brightness-105 transition-all">
            <span>‚≠ê</span> Add to Wishlist Collection
          </button>
        </form>
      {% else %}
        <a href="{% url 'accounts:login' %}?next={{ request.path }}"
          class="block text-center w-full px-4 py-2 rounded-full bg-gradient-to-r from-[#8EEA6E] to-[#5DD65B] text-[#0B2A12] font-semibold text-sm hover:brightness-105 transition-all">
          Login to Save
        </a>
      {% endif %}
    </div>


  <!-- REVIEWS -->
  {% include "places/_reviews.html" with reviews=reviews %}
</article>

<!-- JS -->
<script>
  // COPY ADDRESS
  (() => {
    const btn = document.getElementById("copyAddressBtn");
    if (!btn) return;
    btn.addEventListener("click", async () => {
      const text = btn.dataset.addr || "";
      try {
        await navigator.clipboard.writeText(text);
        const prev = btn.textContent;
        btn.textContent = "Copied!";
        setTimeout(() => (btn.textContent = prev), 1200);
      } catch {
        alert("Address copied:\n" + text);
      }
    });
  })();

  // ‚úÖ DYNAMIC COLLECTION DROPDOWN + FORM HANDLER
  (() => {
    const form = document.getElementById("collectionForm");
    if (!form) return;

    const select = document.getElementById("collectionSelect");
    const newFields = document.getElementById("newCollectionFields");
    const nameInput = document.getElementById("collectionName");
    const descInput = document.getElementById("collectionDesc");
    const csrf = form.querySelector("[name='csrfmiddlewaretoken']").value;
    const placeId = "{{ place.id }}";

    // üîπ Load user collections dynamically
    async function loadCollections() {
      try {
        const res = await fetch("/accounts/collections/list/");
        const data = await res.json();
        select.innerHTML = `<option value="">+ Create New Collection</option>`;
        data.collections.forEach((col) => {
          const opt = document.createElement("option");
          opt.value = col.id;
          opt.textContent = col.name;
          select.appendChild(opt);
        });
      } catch (err) {
        console.warn("Failed to fetch collections:", err);
      }
    }

    loadCollections();

    // Toggle input fields visibility
    select.addEventListener("change", () => {
      if (select.value) {
        newFields.classList.add("hidden");
      } else {
        newFields.classList.remove("hidden");
      }
    });

    // Submit handler
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const btn = form.querySelector("button[type='submit']");
      const orig = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = "Saving...";

      const url = select.value
        ? form.dataset.addUrl
        : form.dataset.createUrl;

      const payload = select.value
        ? { collection_id: select.value, place_id: placeId }
        : { name: nameInput.value.trim(), description: descInput.value.trim(), place_id: placeId };

      try {
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrf,
            "X-Requested-With": "XMLHttpRequest",
          },
          body: JSON.stringify(payload),
        });

        const data = await res.json();
        if (res.ok && data.collection?.id) {
          window.location.href = `/accounts/wishlist/collection/${data.collection.id}/`;
        } else {
          alert(data.error || "Failed to save collection. Please try again.");
        }
      } catch (err) {
        alert("Network error, please try again.");
        console.error(err);
      } finally {
        btn.disabled = false;
        btn.innerHTML = orig;
      }
    });
  })();
</script>


{% endblock %}
