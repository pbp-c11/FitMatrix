{% extends "base.html" %}
{% load humanize %}
{% block title %}Profile Â· FitMatrix{% endblock %}
{% block content %}

<section class="max-w-[1200px] mx-auto px-4 sm:px-6 py-12 space-y-8">

  <!-- Header Profile -->
  <div class="glass card flex flex-col md:flex-row md:items-center md:justify-between gap-6 animate-in">
    <div class="flex items-center gap-6">
      <div class="relative">
        <div class="w-24 h-24 rounded-full overflow-hidden ring-4 ring-[var(--emerald)]">
          {% if request.user.avatar %}
            <img src="{{ request.user.avatar.url }}" alt="{{ request.user.display_name }} avatar" class="w-full h-full object-cover" />
          {% else %}
            <div class="w-full h-full bg-white/10 grid place-items-center text-3xl font-bold">
              {{ request.user.username|slice:":2"|upper }}
            </div>
          {% endif %}
        </div>
      </div>
      <div class="space-y-1">
        <h2 class="text-2xl font-semibold drop-shadow">{{ request.user.display_name }}</h2>
        <p class="text-white/70">{{ request.user.email }}</p>
        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold {% if request.user.is_admin %}bg-[var(--emerald)] text-black{% else %}bg-[var(--mint)] text-black{% endif %}">
          {% if request.user.is_admin %}ADMIN{% else %}USER{% endif %}
        </span>
      </div>
    </div>

    <!-- Logout -->
    <form method="post" action="{% url 'accounts:logout' %}" class="self-start md:self-auto">
      {% csrf_token %}
      <button type="submit" class="btn glass border border-white/20">Log out</button>
    </form>
  </div>

  <!-- Main Layout -->
  <div class="md:grid md:grid-cols-3 gap-6">

    <!-- Sidebar -->
    <nav class="glass card space-y-2 md:sticky md:top-20 h-fit">
      <a href="#account" class="block px-3 py-2 rounded-xl hover:bg-white/10 active:bg-white/20">Account</a>
      <a href="#security" class="block px-3 py-2 rounded-xl hover:bg-white/10 active:bg-white/20">Security</a>
    </nav>

    <!-- Content Sections -->
    <div class="md:col-span-2 space-y-8">

      <!-- Account Section -->
      <section id="account" class="glass card space-y-6">
        <div>
          <h3 class="text-xl font-semibold">Account</h3>
          <p class="text-sm text-white/70">Update your contact details and avatar.</p>
        </div>

        <form method="post" action="{% url 'accounts:profile-edit' %}" enctype="multipart/form-data" class="space-y-4" id="profile-form">
          {% csrf_token %}
          {% if profile_form.non_field_errors %}
            <div class="bg-rose-500/20 border border-rose-500/40 text-rose-100 text-sm p-3 rounded-lg">
              {% for error in profile_form.non_field_errors %}<p>{{ error }}</p>{% endfor %}
            </div>
          {% endif %}

          <div>
            <label for="id_display_name" class="block text-sm font-medium">Display name</label>
            {{ profile_form.display_name }}
            {% for error in profile_form.display_name.errors %}<p class="text-rose-300 text-sm">{{ error }}</p>{% endfor %}
          </div>

          <div>
            <label for="id_email" class="block text-sm font-medium">Email</label>
            {{ profile_form.email }}
            {% for error in profile_form.email.errors %}<p class="text-rose-300 text-sm">{{ error }}</p>{% endfor %}
          </div>

          <div>
            <label for="id_avatar" class="block text-sm font-medium">Avatar</label>
            <div class="flex flex-col sm:flex-row gap-4 items-start">
              <div class="w-20 h-20 rounded-full overflow-hidden bg-white/10" id="avatar-preview">
                {% if request.user.avatar %}
                  <img src="{{ request.user.avatar.url }}" alt="Current avatar" class="w-full h-full object-cover" />
                {% else %}
                  <div class="w-full h-full grid place-items-center text-lg text-white/70">Preview</div>
                {% endif %}
              </div>
              <div class="flex-1">
                {{ profile_form.avatar }}
                <p class="text-xs text-white/60 mt-1">PNG or JPG up to 2MB.</p>
                {% for error in profile_form.avatar.errors %}<p class="text-rose-300 text-sm">{{ error }}</p>{% endfor %}
              </div>
            </div>
          </div>

          <button type="submit" class="btn-primary">Save changes</button>
        </form>
      </section>

      <!-- Security Section -->
      <section id="security" class="glass card space-y-6">
        <div>
          <h3 class="text-xl font-semibold">Security</h3>
          <p class="text-sm text-white/70">Choose a strong password to protect your account.</p>
        </div>

        <form method="post" action="{% url 'accounts:password' %}" class="space-y-4">
          {% csrf_token %}
          <div>
            <label for="id_old_password" class="block text-sm font-medium">Current password</label>
            {{ password_form.old_password }}
          </div>

          <div>
            <label for="id_new_password1" class="block text-sm font-medium">New password</label>
            {{ password_form.new_password1 }}
          </div>

          <div>
            <label for="id_new_password2" class="block text-sm font-medium">Confirm new password</label>
            {{ password_form.new_password2 }}
          </div>

          <button type="submit" class="btn-primary">Update password</button>
        </form>
      </section>

    </div>
  </div>
</section>

{% endblock %}

{% block extra_js %}
<script>
  // Avatar Preview
  const avatarInput = document.querySelector('#profile-form input[type="file"]');
  const avatarPreview = document.getElementById('avatar-preview');
  if (avatarInput && avatarPreview) {
    avatarInput.addEventListener('change', (event) => {
      const [file] = event.target.files;
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          avatarPreview.innerHTML = `<img src="${e.target.result}" alt="Avatar preview" class="w-full h-full object-cover"/>`;
        };
        reader.readAsDataURL(file);
      }
    });
  }
</script>
{% endblock %}
