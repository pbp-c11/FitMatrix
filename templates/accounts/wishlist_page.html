{% extends "base.html" %}
{% block title %}My Wishlist Collections | FitMatrix{% endblock %}

{% block content %}
<section class="max-w-6xl mx-auto px-4 py-12">
  <h1 class="text-2xl font-semibold text-[#0E3A22] mb-6">Wishlist Collections</h1>

  {% if collections %}
    <div id="wishlist-grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6 auto-rows-fr">
      {% for col in collections %}
        <div class="wishlist-card rounded-3xl bg-white/70 border border-[#C9FFD4] shadow-sm p-6 flex flex-col hover:shadow-lg transition-all duration-300"
             data-collection-id="{{ col.id }}">
          
          <!-- Header -->
          <div class="flex justify-between items-start mb-3">
            <h2 class="text-lg font-bold text-[#12391E]">{{ col.name }}</h2>
            <button
              type="button"
              class="text-xs text-red-500 hover:underline delete-btn"
              data-delete-url="{% url 'accounts:delete_collection' col.id %}"
              data-name="{{ col.name }}">
              Delete
            </button>
          </div>

          {% if col.description %}
            <p class="text-sm text-[#3E6147] mb-4">{{ col.description }}</p>
          {% endif %}

          <!-- Footer -->
          <div class="mt-auto flex justify-between items-center pt-8">
            <p class="text-xs text-[#497D5E]">
              {{ col.items.count }} {{ col.items.count|pluralize:"place,places" }}
            </p>
            <a href="{% url 'accounts:wishlist_collection_detail' col.id %}"
               class="text-sm text-[#0E3A22] hover:underline font-medium">
              View Collection →
            </a>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-gray-500 mt-8">You don’t have any wishlist collections yet.</p>
  {% endif %}
</section>

<!-- Toast -->
<div id="toast"
     class="hidden fixed top-6 right-6 px-4 py-3 rounded-xl text-sm font-medium shadow-md border z-[9999] pointer-events-none">
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const grid = document.querySelector("#wishlist-grid");
  const toast = document.querySelector("#toast");

  // ✅ Ambil CSRF token langsung dari cookie
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie("csrftoken");

  // ✅ Toast helper
  function showToast(message, type = "success") {
    toast.textContent = message;
    toast.className = `fixed top-6 right-6 px-4 py-3 rounded-xl text-sm font-medium shadow-md border pointer-events-none ${
      type === "error"
        ? "bg-red-100 text-red-800 border-red-300"
        : "bg-green-100 text-green-800 border-green-300"
    }`;
    toast.classList.remove("hidden");
    setTimeout(() => toast.classList.add("hidden"), 2500);
  }

  // ✅ Handle delete langsung
  document.querySelectorAll(".delete-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const card = btn.closest(".wishlist-card");
      const deleteUrl = btn.dataset.deleteUrl;

      try {
        const res = await fetch(deleteUrl, {
          method: "POST",
          headers: {
            "X-CSRFToken": csrftoken,
            "X-Requested-With": "XMLHttpRequest",
            "Accept": "application/json",
          },
        });

        if (!res.ok) throw new Error("Failed to delete");

        // animasi hilang
        card.style.transition = "opacity 0.3s ease, transform 0.3s ease";
        card.style.opacity = "0";
        card.style.transform = "scale(0.95)";
        setTimeout(() => card.remove(), 300);
        showToast("Collection deleted successfully.");
      } catch (err) {
        console.error(err);
        showToast("Failed to delete collection.", "error");
      }
    });
  });
});
</script>

{% endblock %}
