{% extends "base.html" %}
{% block title %}My Wishlist Collections | FitMatrix{% endblock %}

{% block content %}
<section class="max-w-6xl mx-auto px-4 py-12">
  <h1 class="text-2xl font-semibold text-[#0E3A22] mb-6">Wishlist Collections</h1>

  <!-- hidden csrf -->
  <form id="csrf-form" style="display:none;">{% csrf_token %}</form>


  {% if collections %}
    <div id="wishlist-grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6 auto-rows-fr">
      {% for col in collections %}
        <div class="wishlist-card rounded-3xl bg-white/70 border border-[#C9FFD4] shadow-sm p-6 flex flex-col hover:shadow-lg transition-all duration-300"
             data-collection-id="{{ col.id }}">
          
          <!-- Header -->
          <div>
            <div class="flex justify-between items-start mb-3">
              <h2 class="text-lg font-bold text-[#12391E]">{{ col.name }}</h2>
              <button type="button"
                      class="text-xs text-red-500 hover:underline delete-btn"
                      data-delete-url="{% url 'accounts:delete_collection' col.id %}"
                      data-name="{{ col.name }}">
                Delete
              </button>
            </div>

            {% if col.description %}
              <p class="text-sm text-[#3E6147] mb-4">{{ col.description }}</p>
            {% endif %}
          </div>

          <!-- Footer -->
          <div class="mt-auto flex justify-between items-center pt-8">
            <p class="text-xs text-[#497D5E]">
              {{ col.items.count }} {{ col.items.count|pluralize:"place,places" }}
            </p>
            <a href="{% url 'accounts:wishlist_collection_detail' col.id %}"
               class="text-sm text-[#0E3A22] hover:underline font-medium">
              View Collection →
            </a>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-gray-500 mt-8">You don’t have any wishlist collections yet.</p>
  {% endif %}
</section>

<!-- Custom confirm modal -->
<div id="confirm-modal"
     class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl p-6 w-80 shadow-lg text-center">
    <h2 class="text-lg font-semibold text-[#12391E] mb-2">Delete collection?</h2>
    <p id="confirm-text" class="text-sm text-[#497D5E] mb-6"></p>
    <div class="flex justify-center gap-4">
      <button id="cancel-btn" class="px-4 py-2 text-sm rounded-lg bg-gray-200 hover:bg-gray-300">
        Cancel
      </button>
      <button id="confirm-btn" class="px-4 py-2 text-sm rounded-lg bg-red-500 text-white hover:bg-red-600">
        Delete
      </button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"
     class="hidden fixed top-6 right-6 px-4 py-3 rounded-xl text-sm font-medium shadow-md border z-[9999] pointer-events-none">
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const grid = document.querySelector("#wishlist-grid");
  const toast = document.querySelector("#toast");
  const modal = document.querySelector("#confirm-modal");
  const confirmText = document.querySelector("#confirm-text");
  const cancelBtn = document.querySelector("#cancel-btn");
  const confirmBtn = document.querySelector("#confirm-btn");
  let deleteUrl = null;
  let targetCard = null;

  const csrftoken = document.querySelector("#csrf-form [name=csrfmiddlewaretoken]")?.value;


  /* ✅ toast fix: selalu di layar atas kanan */
  function showToast(message, type = "success") {
    toast.textContent = message;
    toast.classList.remove("hidden");
    toast.style.position = "fixed";
    toast.style.top = "24px";
    toast.style.right = "24px";
    toast.style.zIndex = "9999";
    toast.className = `fixed px-4 py-3 rounded-xl text-sm font-medium shadow-md border pointer-events-none ${
      type === "error"
        ? "bg-red-100 text-red-800 border-red-300"
        : "bg-green-100 text-green-800 border-green-300"
    }`;
    setTimeout(() => toast.classList.add("hidden"), 2500);
  }

  // modal open
  function openModal(name, url, card) {
    confirmText.textContent = `Are you sure you want to delete “${name}”?`;
    modal.classList.remove("hidden");
    deleteUrl = url;
    targetCard = card;
  }

  // modal close
  function closeModal() {
    modal.classList.add("hidden");
    deleteUrl = null;
    targetCard = null;
  }

  // bind delete buttons
  document.querySelectorAll(".delete-btn").forEach(btn => {
    btn.addEventListener("click", () =>
      openModal(btn.dataset.name, btn.dataset.deleteUrl, btn.closest(".wishlist-card"))
    );
  });

  cancelBtn.addEventListener("click", closeModal);

  confirmBtn.addEventListener("click", async () => {
    if (!deleteUrl || !targetCard) return;
    closeModal();

    try {
      const res = await fetch(deleteUrl, {
        method: "POST",
        headers: { "X-CSRFToken": csrftoken, "Accept": "application/json" },
      });
      if (!res.ok) throw new Error("Bad response");

      targetCard.style.transition = "opacity 0.35s ease, transform 0.35s ease";
      targetCard.style.opacity = "0";
      targetCard.style.transform = "scale(0.95)";
      setTimeout(() => {
        targetCard.remove();
        grid.style.display = "block";
        void grid.offsetWidth;
        grid.style.display = "grid";
      }, 350);
      showToast("Collection deleted successfully.");
    } catch (e) {
      showToast("Failed to delete collection.", "error");
    }
  });
});
</script>


{% endblock %}
